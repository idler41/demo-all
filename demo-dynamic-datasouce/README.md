## 业务场景

1. 数据库读写分离
2. 需要访问不同的数据库

## 解决方案

一般方案是采用多套数据源，执行时动态切换。



### AbstractRoutingDataSource

springboot提供AbstractRoutingDataSource类实现动态切换。

- 集成dataSource接口，并持有所有datasource的map
- 自定义注解，aop拦截读取注解获取key放入threadlocal
- 自定义类继承AbstractRoutingDataSource，determineCurrentLookupKey()通过threadlocal获取key



优点：不用一个datasource绑定一个sessionFactory

缺点：扩容不灵活，代码有侵入性



### 数据库代理

RDS数据库代理是位于数据库服务端和应用服务端之间的网络代理服务，用于代理应用服务端访问数据库时的所有请求，具有高可用、高性能、可运维、简单易用等特点，同时提供自动读写分离、事务拆分、连接池等高级功能。

### 适用场景

代理终端适用于**纯只读**和**有隔离需求**的业务。

1个主实例和4个只读实例的RDS实例，将A业务（纯只读）和B业务（可读可写）都连接至该实例。可以将只读实例1和只读实例2组成代理终端A（**只读**模式）提供给业务A，主实例、只读实例3和只读实例4组成代理终端B（**读写**模式）提供给业务B，以实现两个业务在数据库使用上的物理隔离，避免相互影响。

### 代理终端使用注意事项、

- 当主实例或只读实例变更配置时可能会出现连接闪断
- 新增只读实例后，新建的连接才会被路由到新只读实例上
- 使用独享代理连接地址时，事务请求都会路由到主实例
- 使用独享代理连接地址进行读写分离时，不保证非事务读的一致性，业务上有读一致性需求可以封装到事务中



# 参考链接



https://www.cnblogs.com/masonlee/p/12207853.html